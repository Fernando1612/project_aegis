version: '3.9'

networks:
  trading_net:
    driver: bridge

services:
  freqtrade:
    image: freqtradeorg/freqtrade:stable
    container_name: aegis_pilot
    restart: always
    volumes:
      - ./freqtrade/user_data:/freqtrade/user_data
    command: >
      trade --logfile /freqtrade/user_data/logs/freqtrade.log --db-url sqlite:////freqtrade/user_data/tradesv3.sqlite --config /freqtrade/user_data/config.json --strategy AEGIS_Strategy
    networks:
      - trading_net
    ports:
      - "8080:8080"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - TZ=${TZ:-UTC}

  mcp_wrapper:
    build: ./mcp_wrapper
    container_name: aegis_bridge
    restart: always
    networks:
      - trading_net
    ports:
      - "8000:8000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - TZ=${TZ:-UTC}
      - FREQTRADE_API_URL=${FREQTRADE_API_URL:-http://freqtrade:8080}
      - FREQTRADE_USERNAME=${FREQTRADE_USERNAME:-freqtrader}
      - FREQTRADE_PASSWORD=${FREQTRADE_PASSWORD:-maceda}
    depends_on:
      - freqtrade

  aegis_brain:
    build: ./aegis_brain
    container_name: aegis_strategist
    restart: always
    networks:
      - trading_net
    volumes:
      - ./aegis_brain/memory.db:/app/memory.db
      - /var/run/docker.sock:/var/run/docker.sock
      - ./freqtrade/user_data:/freqtrade/user_data
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    env_file:
      - .env
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - TZ=${TZ:-UTC}
      - MCP_SERVER_URL=http://mcp_wrapper:8000
    depends_on:
      - mcp_wrapper
